#!/bin/bash

# First part remains the same
echo "*results<<EOF" >> $GITHUB_ENV
echo "$RESULTS" >> $GITHUB_ENV
echo "EOF" >> $GITHUB_ENV

name: Push report to wiki
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TAG: ${{ env.TAG }}
  NEXT_TAG: ${{ env.NEXT_TAG }}
  INTEGRATION_RESULTS: ${{ env.results }}
run: |
  git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.kp.org/${{ github.repository }}.wiki.git wiki
  ls -la wiki
  
  # Path to the file
  FILE="wiki/test_results_v${{ env.NEXT_TAG }}.md"
  
  # Replace the Integration Test Results section
  if [ -f "$FILE" ]; then
    echo "Updating integration test results in $FILE"
    awk -v new_results="${{ env.results }}" '
      BEGIN { in_integration = 0; printed = 0 }
      /^# Integration Test Results/ { 
        if (!printed) {
          print $0
          print new_results
          printed = 1
        }
        in_integration = 1
        next
      }
      /^#/ { in_integration = 0 }
      !in_integration { print }
    ' "$FILE" > temp.md && mv temp.md "$FILE"
  else
    echo "Creating new test results file"
    echo "# Integration Test Results" > "$FILE"
    echo "${{ env.results }}" >> "$FILE"
  fi
  
  cd wiki
  git config user.name "${{ github.actor }}"
  git config user.email "${{ github.actor }}@users.noreply.github.com"
  git add .
  git commit -m "Update integration test results in v$NEXT_TAG"
  git push
