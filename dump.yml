#!/bin/bash

FILE="wiki/test_results_v${{ env.NEXT_TAG }}.md"

if [ -f "$FILE" ]; then
    echo "Replacing integration test results in $FILE"
    awk -v new_results="${{ env.results }}" '
    BEGIN { in_integration = 0 }
    /^# Integration Test Results/ { 
        print;
        print new_results;
        in_integration = 1;
        next;
    }
    /^#/ && in_integration { 
        in_integration = 0 
    }
    !in_integration { print }
    ' "$FILE" > temp.md && mv temp.md "$FILE"
    
    # Check if changes were made
    if [ -n "$(git status -s "$FILE")" ]; then
        cd wiki
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        git add "$FILE"
        git commit -m "Update integration test results in v$NEXT_TAG"
        git push
    else
        echo "No changes detected in content"
    fi
else
    echo "Creating new file: $FILE"
    mkdir -p "$(dirname "$FILE")"
    echo "# Integration Test Results" > "$FILE"
    echo "${{ env.results }}" >> "$FILE"
    
    cd wiki
    git config user.name "${{ github.actor }}"
    git config user.email "${{ github.actor }}@users.noreply.github.com"
    git add "$FILE"
    git commit -m "Update integration test results in v$NEXT_TAG"
    git push
fi

# Debug: Show final content
echo "Final content of $FILE:"
cat "$FILE"
