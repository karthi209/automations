#!/bin/bash

FILE="wiki/test_results_v${{ env.NEXT_TAG }}.md"

if [ -f "$FILE" ]; then
    echo "Updating integration test results in $FILE"
    # Save original content for comparison
    cp "$FILE" "$FILE.orig"
    
    awk -v new_results="${{ env.results }}" '
        /^# Integration Test Results/ {
            print;
            print new_results;
            in_section = 1;
            next;
        }
        /^#/ {
            in_section = 0;
            print;
            next;
        }
        !in_section {
            print;
        }
    ' "$FILE" > temp.md
    mv temp.md "$FILE"
    
    # Check if content actually changed
    if ! cmp -s "$FILE" "$FILE.orig"; then
        echo "Changes detected, proceeding with commit"
        rm "$FILE.orig"
        cd wiki
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        git add "$FILE"
        git commit -m "Update integration test results in v$NEXT_TAG"
        git push
    else
        echo "No changes detected in content, skipping commit"
        rm "$FILE.orig"
    fi
else
    echo "Creating new file: $FILE"
    echo "# Integration Test Results" > "$FILE"
    echo "${{ env.results }}" >> "$FILE"
    
    cd wiki
    git config user.name "${{ github.actor }}"
    git config user.email "${{ github.actor }}@users.noreply.github.com"
    git add "$FILE"
    git commit -m "Update integration test results in v$NEXT_TAG"
    git push
fi
